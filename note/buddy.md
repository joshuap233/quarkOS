https://github.com/wuwenbin/buddy2/blob/master/buddy2.c